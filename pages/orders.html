<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đơn hàng | Café Focus</title>
    <link rel="stylesheet" href="../assets/fonts/fonts.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="../images/logo1.jpg">
    <style>

        .orders-hero { padding: 36px 0; text-align: left; }
        .orders-grid { display: grid; grid-template-columns: 1fr 360px; gap: 24px; align-items: start; }
        .orders-list { display:flex; flex-direction:column; gap:16px; }
        .order-card { background:#fff;border-radius:12px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,0.06); border:1px solid #f0f0f0; transition:transform .12s ease,box-shadow .12s ease; }
        .order-card:hover{ transform: translateY(-4px); box-shadow:0 14px 40px rgba(0,0,0,0.08);}
        .order-meta{ display:flex;justify-content:space-between;align-items:center;gap:12px;}
        .order-items ul{ margin:8px 0 0 0; color:#333; padding:0; list-style:none }
        .order-items li{ margin:8px 0; display:flex; justify-content:space-between; gap:8px; font-size:0.95rem; color:#444; padding-bottom:4px; border-bottom:1px dashed #f3f3f3}
        .order-items li:last-child{ border-bottom:0; }
        .orders-empty{ padding:24px;background:#fff;border-radius:12px;text-align:center;color:#666 }
        .order-badge{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:700; color:#fff; font-size:0.9rem; }
        .status-dot{ width:10px; height:10px; border-radius:50%; display:inline-block; box-shadow:0 0 0 4px rgba(255,255,255,0.08); }
        .status-select{ padding:8px 10px;border-radius:8px;border:1px solid #e6e6e6;background:#fff;cursor:pointer; font-weight:600;}
        .order-footer{ display:flex; justify-content:flex-end; align-items:center; margin-top:12px; gap:10px; }
        .order-total{ font-size:1rem; font-weight:800; color:#111; }
        .customer-info{ margin-top:8px; color:#333; font-size:0.95rem; background:#fafafa; padding:10px; border-radius:8px; }
        .toggle-details{ background:transparent;border:1px solid #e6e6e6;padding:6px 10px;border-radius:8px; cursor:pointer;}
        @media (max-width: 900px) { .orders-grid { grid-template-columns: 1fr; } .order-items{ display:block!important; } }
    </style>
</head>
<body>

       <nav class="navbar">
            <div class="container">
                <a href="../index.html" class="logo">
                    <img src="../images//logo1.jpg" alt="Café Focus Logo" height="40">
                    <span>Café Focus</span>
                </a>
                
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                
                <ul class="nav-menu" id="navMenu">
                    <li><a href="../index.html" >TRANG CHỦ</a></li>
                    <li><a href="about.html" >VỀ CHÚNG TÔI</a></li>
                    <li><a href="services.html">KHÔNG GIAN & DỊCH VỤ</a></li>
                    <li><a href="menu.html" >MENU</a></li>  
                    <li><a href="contact.html">ĐẶT BÀN</a></li>  
                    <li><a href="reviews.html">ĐÁNH GIÁ <i class="fas fa-star"></i></a></li>
                </ul>
                
                <!-- User Menu - ĐÃ DI CHUYỂN VÀO TRONG CONTAINER -->
                <div class="user-menu" id="userMenu">
                    <button class="user-btn" id="userBtn">
                        <span id="userName">Tài khoản</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="user-info">
                            <div class="user-avatar" id="userAvatar">ND</div>
                            <div>
                                <strong id="dropdownUserName">Người dùng</strong>
                                <small id="userEmail">user@example.com</small>
                            </div>
                        </div>
                        <div class="dropdown-divider"></div>
                        <a href="orders.html" class="dropdown-item">
                            <i class="fas fa-shopping-bag"></i> Đơn hàng
                        </a>
                        <button class="dropdown-item logout-btn" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i> Đăng xuất
                        </button>
                    </div>
                </div>
            </div>
        </nav>

    <main>
        <section class="orders-hero">
            <div class="container">
                <h1 class="section-title">Lịch sử đơn hàng</h1>
            </div>
        </section>

        <section style="padding:20px 0;">
            <div class="container">
                <!-- Filters for orders -->
                <div class="orders-filters" style="display:flex;gap:10px;align-items:center;margin:0 0 16px;flex-wrap:wrap;">
                    <select id="order-filter-status" style="padding:8px;border-radius:8px;border:1px solid #ddd;">
                        <option value="all">Tất cả trạng thái</option>
                        <option value="Processing">Đang xử lý</option>
                        <option value="Confirmed">Đã xác nhận</option>
                        <option value="Preparing">Đang chuẩn bị</option>
                        <option value="Ready">Sẵn sàng</option>
                        <option value="Paid">Đã thanh toán</option>
                        <option value="Delivered">Đã giao</option>
                        <option value="Cancelled">Đã hủy</option>
                    </select>

                    <input id="order-filter-search" placeholder="Tìm kiếm tên khách, điện thoại, email..." style="flex:1;min-width:200px;padding:8px;border-radius:8px;border:1px solid #ddd;" />

                    <button id="order-filter-clear" style="padding:8px 12px;border-radius:8px;border:none;background:#95a5a6;color:white;cursor:pointer;">Xóa</button>
                </div>

                <div class="orders-grid">
                    <div class="orders-list" id="ordersContainer">
                        <!-- Orders will be populated here -->
                    </div>

                    <aside>
                        <div class="order-card">
                            <h3 style="margin:0 0 8px">Tổng quan</h3>
                            <p id="ordersCount" style="margin:0 0 8px;color:#666">Tổng số đơn: 0</p>
                            <div style="border-top:1px dashed #eee;padding-top:10px;margin-top:10px;color:#333">
                                <div><strong>Tổng số tiền:</strong> <span id="ordersSum">0₫</span></div>
                            </div>
                        </div>
                    </aside>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer (consistent layout) -->
    <footer class="footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-col">
                    <h3>Café Focus</h3>
                    <p>Mô hình Café Focus kết hợp công nghệ, mang đến không gian làm việc & học tập hiệu quả nhất</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-tiktok"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h3>Liên kết nhanh</h3>
                    <ul>
                        <li><a href="../index.html">TRANG CHỦ</a></li>
                        <li><a href="about.html">VỀ CHÚNG TÔI</a></li>
                        <li><a href="services.html">KHÔNG GIAN & DỊCH VỤ</a></li>
                        <li><a href="menu.html">MENU</a></li>
                        <li><a href="contact.html">ĐẶT BÀN</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h3>Liên hệ</h3>
                    <p><i class="fas fa-map-marker-alt"></i> 123A, Đường Nguyễn Văn Cừ Nối Dài, Phường Ninh Kiều, Cần Thơ</p>
                    <p><i class="fas fa-phone"></i> 0909 123 456</p>
                    <p><i class="fas fa-envelope"></i> info@cafefocus.com</p>
                </div>
                <div class="footer-col">
                    <h3>Giờ mở cửa</h3>
                    <p>Thứ 2 - Thứ 7: 7:00 - 00:00</p>
                    <p>Chủ nhật: 7:00 - 22:00</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Café Focus. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
    // Global variable to store all visible orders for filtering
    let allVisibleOrders = [];

    function formatPrice(num){
        return new Intl.NumberFormat('vi-VN').format(num) + '₫';
    }

    function getStatusBadgeColor(status) {
        const colors = {
            'Processing': '#FFA500',
            'Confirmed': '#4169E1',
            'Preparing': '#FF6347',
            'Ready': '#32CD32',
            'Paid': '#6495ED',
            'Delivered': '#228B22',
            'Cancelled': '#808080'
        };
        return colors[status] || '#999';
    }

    function getStatusBadgeText(status) {
        const texts = {
            'Processing': 'Đang xử lý',
            'Confirmed': 'Đã xác nhận',
            'Preparing': 'Đang chuẩn bị',
            'Ready': 'Sẵn sàng',
            'Paid': 'Đã thanh toán',
            'Delivered': 'Đã giao',
            'Cancelled': 'Đã hủy'
        };
        return texts[status] || status;
    }

    function updateOrderStatus(orderId, newStatus) {
        const orders = JSON.parse(localStorage.getItem('cafeOrders') || '[]');
        const order = orders.find(o => o.id === orderId);
        if (order) {
            order.status = newStatus;
            localStorage.setItem('cafeOrders', JSON.stringify(orders));
            renderOrders();
        }
    }

    function renderOrders(){
        const container = document.getElementById('ordersContainer');
        const orders = JSON.parse(localStorage.getItem('cafeOrders') || '[]');
        const ordersCount = document.getElementById('ordersCount');
        const ordersSum = document.getElementById('ordersSum');
        const userData = JSON.parse(localStorage.getItem('cafeUser') || 'null');
        const isAdmin = userData?.role === 'admin';
        
        container.innerHTML = '';

        if(!orders || orders.length === 0){
            container.innerHTML = '<div class="orders-empty">Không có đơn hàng nào.</div>';
            if(ordersCount) ordersCount.textContent = 'Tổng số đơn: 0';
            if(ordersSum) ordersSum.textContent = '0₫';
            return;
        }

        // Filter orders for regular users: only show orders belonging to the logged-in user
        let visibleOrders = isAdmin ? orders : orders.filter(o => {
            if (!userData) return false;
            if (o.userId && userData.id) return o.userId === userData.id;
            if (o.userEmail && userData.email) return o.userEmail === userData.email;
            return (o.customer && o.customer.email && userData.email) ? o.customer.email === userData.email : false;
        });

        // Store for filter reference
        allVisibleOrders = visibleOrders;

        // Apply UI filters (status + search)
        const statusFilterEl = document.getElementById('order-filter-status');
        const searchFilterEl = document.getElementById('order-filter-search');
        const statusFilter = statusFilterEl ? statusFilterEl.value : 'all';
        const q = searchFilterEl ? searchFilterEl.value.trim().toLowerCase() : '';

        if (statusFilter && statusFilter !== 'all') {
            visibleOrders = visibleOrders.filter(o => (o.status || 'Processing') === statusFilter);
        }

        if (q) {
            visibleOrders = visibleOrders.filter(o => {
                const custName = (o.customer?.name || '').toLowerCase();
                const custPhone = (o.customer?.phone || '').toLowerCase();
                const custEmail = (o.customer?.email || '').toLowerCase();
                return custName.includes(q) || custPhone.includes(q) || custEmail.includes(q);
            });
        }

        if (!visibleOrders || visibleOrders.length === 0) {
            container.innerHTML = '<div class="orders-empty">Không có đơn hàng nào.</div>';
            if(ordersCount) ordersCount.textContent = 'Tổng số đơn: 0';
            if(ordersSum) ordersSum.textContent = '0₫';
            return;
        }

        let totalSum = 0;
        visibleOrders.forEach(order => {
            totalSum += Number(order.total || 0);

            const el = document.createElement('div');
            el.className = 'order-card';
            const date = new Date(order.date).toLocaleString('vi-VN');
            const status = order.status || 'Processing';
            const statusColor = getStatusBadgeColor(status);
            const statusText = getStatusBadgeText(status);

            const items = order.items || [];
            const itemsHtml = '<ul>' + items.map(i=>`<li><div>${i.name} <span class="qty">x${i.quantity}</span></div><div>${formatPrice(i.price*i.quantity)}</div></li>`).join('') + '</ul>';

            let statusHtml = `<div class="order-badge" style="background:${statusColor}"><span class="status-dot" style="background:#fff;opacity:0.85"></span><span style="margin-left:6px">${statusText}</span></div>`;
            const paymentMethodMap = {
                cash: 'Tiền mặt',
                momo: 'Ví MoMo',
                banking: 'Chuyển khoản'
            };

            const paymentLabel =
                paymentMethodMap[order.paymentMethod || order.customer?.method] || 'Chưa xác định';

            if (isAdmin) {
                statusHtml = `
                    <select class="status-select" data-order-id="${order.id}" onchange="updateOrderStatus(${order.id}, this.value)">
                        <option value="Processing" ${status === 'Processing' ? 'selected' : ''}>Đang xử lý</option>
                        <option value="Confirmed" ${status === 'Confirmed' ? 'selected' : ''}>Đã xác nhận</option>
                        <option value="Preparing" ${status === 'Preparing' ? 'selected' : ''}>Đang chuẩn bị</option>
                        <option value="Ready" ${status === 'Ready' ? 'selected' : ''}>Sẵn sàng</option>
                        <option value="Paid" ${status === 'Paid' ? 'selected' : ''}>Đã thanh toán</option>
                        <option value="Delivered" ${status === 'Delivered' ? 'selected' : ''}>Đã giao</option>
                        <option value="Cancelled" ${status === 'Cancelled' ? 'selected' : ''}>Đã hủy</option>
                    </select>
                `;
            }

            el.innerHTML = `
                <div class="order-meta">
                    <div>
                        <strong>Đơn #${order.id}</strong>
                        <div style="color:#666;font-size:0.95rem">${date}</div>
                    </div>
                    <div style="text-align:right">
                        <div class="order-total">${formatPrice(order.total)}</div>
                        <div style="margin-top:6px">${statusHtml}</div>
                    </div>
                </div>

                <div class="order-items" style="margin-top:10px">${itemsHtml}</div>

                <div class="customer-info">
                    <div><strong>Khách hàng:</strong> ${order.customer?.name || 'N/A'} ${order.customer?.phone ? ' - ' + order.customer.phone : ''}</div>
                    ${order.customer?.email ? `<div style="color:#666">${order.customer.email}</div>` : ''}
                    <div style="margin-top:6px">
                        <strong>Phương thức thanh toán:</strong> ${paymentLabel}
                    </div>

                    ${order.customer?.notes ? `<div class="order-notes" style="margin-top:6px;color:#666"><strong>Ghi chú:</strong> ${order.customer.notes}</div>` : ''}
                </div>

                <div class="order-footer">
                    <div style="text-align:right"><strong>Tổng:</strong> ${formatPrice(order.total)}</div>
                </div>
            `;

            container.appendChild(el);
        });

        if(ordersCount) ordersCount.textContent = 'Tổng số đơn: ' + visibleOrders.length;
        if(ordersSum) ordersSum.textContent = formatPrice(totalSum);
    }

    window.addEventListener('DOMContentLoaded', function(){
        renderOrders();
        
        // Attach filter control handlers
        const statusEl = document.getElementById('order-filter-status');
        const searchEl = document.getElementById('order-filter-search');
        const clearBtn = document.getElementById('order-filter-clear');
        if (statusEl) statusEl.onchange = renderOrders;
        if (searchEl) searchEl.oninput = debounce(renderOrders, 300);
        if (clearBtn) clearBtn.onclick = function() { if(statusEl) statusEl.value = 'all'; if(searchEl) searchEl.value = ''; renderOrders(); };
        
        const container = document.getElementById('ordersContainer');
        container?.addEventListener('click', function(e){
            const t = e.target;
            if (t.classList.contains('toggle-details')){
                const card = t.closest('.order-card');
                const items = card.querySelector('.order-items');
                const notes = card.querySelector('.order-notes');
            
            }
        });
    });
    </script>
      <script src="../js/script.js"></script>
</body>
</html>